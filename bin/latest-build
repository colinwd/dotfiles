#!/usr/bin/env python
"""Returns the last successful Jenkins # build for a project."""

import json
import os
import requests
import sys
from requests.packages.urllib3.exceptions import InsecureRequestWarning


def usage():
    return """
Usage:

latest-build            Uses your current directory to try and match a job in Jenkins
latest-build [name]     Searches for the specified job in Jenkins
    """


def get_last_successful_build(job_name):
    """
    Grab job by name and get the last successful build number.

    Returns 0 if something goes wrong.
    """
    r = requests.get('https://jenkins.mobiusteam.net/job/' + job_name +
                     '/lastSuccessfulBuild/api/json', verify=False)

    if r.status_code is not 200:
        return 0

    return json.loads(r.text)['number']


def all_jobs():
    """Generate list of all job names in Jenkins."""
    r = requests.get('https://jenkins.mobiusteam.net/api/json', verify=False)
    jobs = json.loads(r.text)['jobs']

    for job in jobs:
        yield job['name'].split(' ')[0]

if __name__ == '__main__':
    requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

    if len(sys.argv) == 2:
        arg = sys.argv[1]
        if arg == '-h' or arg == '--help':
            print(usage())
            sys.exit(1)
        else:
            project_name = arg
    else:
        project_name = os.getcwd().split('/')[-1]

    exact_match = get_last_successful_build(project_name)

    if exact_match != 0:
        print(exact_match)
    else:
        matched_jobs = [job for job in all_jobs() if project_name in job]

        if len(matched_jobs) == 0:
            print('Unable to find project "' + project_name + '" in Jenkins!')
            sys.exit(1)

        candidates = {str(i+1): job for i, job in enumerate(matched_jobs)}
        [print(str(k) + '. ' + v) for k, v in sorted(candidates.items())]
        print('\nWhich job did you want? ', sep='')

        selection = input()
        print()
        print(get_last_successful_build(candidates[selection]))
